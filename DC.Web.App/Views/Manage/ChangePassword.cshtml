@model DC.Web.App.Models.ResetPasswordModel
@{
    ViewBag.Title = "Change Password";


    if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin")  )
    {
        Layout = "~/Areas/CP/Views/Shared/_LayoutM.cshtml";
    }
    if (User.IsInRole("User"))
    {
        Layout = "~/Areas/MyLibrary/Views/Shared/_LayoutM.cshtml";
    }
    if (User.IsInRole("School"))
    {
        Layout = "~/Areas/MySchool/Views/Shared/_LayoutM.cshtml";
    }
    if (User.IsInRole("Student"))
    {
        Layout = "~/Areas/Student/Views/Shared/_LayoutM.cshtml";
    }
}
 
    
    <div class="col-lg-12">
        <div id="pnlbody" class="pnlbody">
            <h3 class="text-center"><i class="text-muted fa fa-lock fa-2x"></i></h3>
            <h2 class="text-center">Reset Password?</h2>
            <p class="text-center">You can change your password here.</p>
            @using (Html.BeginForm(null, null, FormMethod.Post, new { role = "form", autocomplete = "off", name = "frmChangePassword", id = "frmChangePassword", }))
            {
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                @Html.HiddenFor(m => m.Id)
                @Html.HiddenFor(m => m.ePassword)
                @Html.AntiForgeryToken()
                <div class="form-group">
                    @Html.LabelFor(model => model.OldPassword, htmlAttributes: new { @class = "control-label " })
                    <strong title="Required." class="text-danger ">*&nbsp; </strong> @Html.ValidationMessageFor(t => t.OldPassword, "", new { @class = "small text-danger pull-right" })
                    @Html.PasswordFor(model => model.OldPassword, new { @class = "form-control", @placeholder = Html.DisplayNameFor(model => model.OldPassword) })
                </div>
                <div class="form-group">
                    @Html.LabelFor(model => model.Password, htmlAttributes: new { @class = "control-label" })
                    <strong title="Required." class="text-danger ">*&nbsp; </strong> @Html.ValidationMessageFor(t => t.Password, "", new { @class = "small text-danger pull-right" })
                    @Html.PasswordFor(model => model.Password, new { @class = "form-control", @placeholder = Html.DisplayNameFor(model => model.Password) })
                </div>
                <div class="form-group">
                    @Html.LabelFor(model => model.ConfirmPassword, htmlAttributes: new { @class = "control-label" })
                    <strong title="Required." class="text-danger ">*&nbsp; </strong> @Html.ValidationMessageFor(t => t.ConfirmPassword, "", new { @class = "small text-danger pull-right" })
                    @Html.PasswordFor(model => model.ConfirmPassword, new { @class = "form-control", @placeholder = Html.DisplayNameFor(model => model.ConfirmPassword) })
                </div>
                <button id="btnSubmit" name="recover-submit" class="jsLoading btn btn-lg btn-primary btn-block" type="submit">Change Password</button>

            }

        </div>
        <div id="psuccess" class="hidden text-center">

            <h3>
                <i class="text-success fa fa-check-circle fa-4x"></i>
                <hr />Password has been changed successfully.<hr />
            </h3>


        </div>
    </div>


 
@section Scripts {
    <script src="~/Scripts/jquery.toaster.js"></script>
    <script src="~/Scripts/bootbox.min.js"></script>
    <script src="~/Scripts/Common.js"></script>
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(function () {
            $("#OldPassword").val("");
            var btntext = "";
            $(document).ajaxSend(function (event, xhr, settings) {
                btntext = $(".jsLoading").html();
                $(".jsLoading").attr("disabled", "disabled");
                $(".jsLoading").html("working on it wait..")
                $(".jsLoading").attr("disabled", "disabled");
            });
            $(document).ajaxComplete(function (event, xhr, settings) {
                $(".jsLoading").html(btntext)
                $(".jsLoading").removeAttr("disabled");

            });
            $(document).on("submit", "#frmChangePassword", function (e) {
                e.preventDefault();
                var Id = $.trim($("#Id").val());
                var OldPassword = $.trim($("#OldPassword").val());
                var ePassword = $.trim($("#ePassword").val());
                if (ePassword != OldPassword)
                {
                    var message = ' <div role="alert" class="jsMessage  alert alert-success"><span aria-hidden="true" class="glyphicon glyphicon-exclamation-sign"></span><span class="sr-only">Error:</span></a>';
                    $.toaster({ priority: 'danger', title: "Password icorrect ", message: "Please type correct old password. " });
                    $("#OldPassword").focus();
                    return;
                }
                var Password = $.trim($("#Password").val());
                if ($(this).valid()) {

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("ChangePassword", "Manage", new {area="" })',
                        data: {
                            Id: Id, ePassword: ePassword, OldPassword: OldPassword, Password: Password
                        },
                        success: function (data) {
                            if (data.data == "1") {
                                $("#pnlbody").addClass("hidden");
                                $("#psuccess").removeClass("hidden");
                                var message = ' <div role="alert" class="jsMessage  alert alert-success"><span aria-hidden="true" class="glyphicon glyphicon-exclamation-sign"></span><span class="sr-only">Inserted:</span></a>';
                                //$.toaster({ priority: 'success', title: "Password changed.", message: "password changed successfully." });
                            }
                            else {
                                $("#psuccess").addClass("hidden");
                                $("#pnlbody").removeClass("hidden");
                                message = ' <div role="alert" class="jsMessage  alert alert-success"><span aria-hidden="true" class="glyphicon glyphicon-exclamation-sign"></span><span class="sr-only">Error:</span></a>';
                                $.toaster({ priority: 'danger', title: "Password incorrect ", message: data.data });
                                $("#OldPassword").focus();
                            }
                        }
                    });
                }
                else {
                    return false;
                }
            });
        });
    </script>

}
