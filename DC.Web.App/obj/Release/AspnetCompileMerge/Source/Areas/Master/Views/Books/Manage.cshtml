@model DC.CustomMessage<List<DC.sKeyValue>>
    @{
    ViewBag.Title = $"Manage Books::{Model.Detail}";
    }

    @if (Model != null && Model.Status == 200)
    {
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <ol class="breadcrumb" id="olBredcrumb">
                    <li class="breadcrumb-item">
                        <a href="@Url.Action(" Index","Dashboard",new {area="CP" })">Home</a>
                    </li>
                    @foreach (var item in Model.Data.OrderBy(m => m.Id))
                    {
                    if (item.Id == Model.iId)
                    {
                    <li class="breadcrumb-item   "> @item.Title <span class="text-secondary"><i
                                class="fa fa-fw fa-angle-double-right"></i>Manage Books</span> </li>

                    }
                    else
                    {
                    <li class="breadcrumb-item   "> <a href="@Url.Action("", " Book", new { area=""
                            })/@item.SlugUrl?catid=@item.Id"> @item.Title</a> </li> } } </ol> </div> <div
                            class="col-md-12">
                            <div id="pageAdd" class="form-data"></div>
            </div>

        </div>



        <div id="pageData" class="text-center">
            <div class="row">
                <div class="col-lg-8 col-xs-8">
                    <div class="form-group has-feedback ">
                        @Html.HiddenFor(m => m.iId)
                        <input onkeyup="Search()" type="text" class="form-control" id="txtSearch" name="txtSearch"
                            placeholder="Search By Name">
                        <span class="fa fa-search form-control-feedback"></span>
                    </div>
                </div>


                <div class="col-lg-4 col-xs-4 text-right ">
                    <button type="button" title="Click refresh data." class="btn btn-sm  btn-primary"
                        onclick="return FillData();"><i class="fa fa-refresh"></i></button>
                    <button type="button" id="btnAdd" onclick="return Add('Create New Book','');"
                        title="Click for add ." class="btn btn-sm btn-primary"><i class="fa fa-plus"></i></button>
                </div>

                <div class="col-lg-12">
                    <table id="tblData" class="table table-bordered">
                        <tr>
                            <td class="text-center">
                                Working on it <img src="~/Images/inlineloader.gif" />
                            </td>
                        </tr>

                    </table>
                </div>

            </div>



        </div>
    </div>
    }
    else
    {
    <div class="row text-center">
        <div class="col-lg-12">
            <table class="table table-bordered">
                <tr>
                    <td class="text-center h4 text-danger">
                        <h4>@Model.Message</h4>
                        Seems to be url has been tempered.
                    </td>
                </tr>

            </table>
        </div>
    </div>
    }
    @section Scripts {

    <script src="~/Scripts/jquery.toaster.js"></script>
    <script src="~/Scripts/bootbox.min.js"></script>
    <script src="~/Scripts/Common.js"></script>


    <script>
        function CancelAdd() {

            $("#pageData").css({
                "display": ""
            })
            $("#pageAdd").css({
                "display": "none"
            })
        }

        function Search() {
            var input, filter, table, tr, td, i;
            input = document.getElementById("txtSearch");
            filter = input.value.toUpperCase();
            table = document.getElementById("tblData");
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }

            }
        }

        function Add(title, id) {
            var btnhtml = $("#btnAdd").html();
            $("#btnAdd").html("Wait.. <i class='fa fa-spinner fa-spin'></i>");
            $("#btnAdd").attr("disabled", "disabled");
            AddLoader();
            var MasterCategoryId = $("#iId").val();
            $.ajax({
                type: "GET",
                url: '@Url.Action("AddBook", "Books", new {area="Master" })',
                data: {
                    Id: id,
                    Title: '',
                    MasterCategoryId: MasterCategoryId
                },
                success: function (data) {
                    $("#btnAdd").html(btnhtml);
                    $("#btnAdd").removeAttr("disabled");
                    $("#pageAdd").css({
                        "display": ""
                    });
                    $("#pageData").css({
                        "display": "none"
                    });
                    $("#pageAdd").html(data);
                    title = title == "" ? "Create New Book" : title;
                    $("#h3Title").html(title);
                },
                complete: function (data) {
                    $("#btnAdd").html(btnhtml);
                    $("#btnAdd").removeAttr("disabled");
                    RemoveLoader();
                },
                error: function (data) {

                    $("#btnAdd").html(btnhtml);
                    $("#btnAdd").removeAttr("disabled");
                    RemoveLoader();
                }
            });
        }

        function View(popupTitle, id) {
            AddLoader();
            $.ajax({

                type: "GET",
                url: '@Url.Action("ViewBook", "Books", new {area="Master" })',
                data: {
                    Id: id
                },
                success: function (data) {

                    bootbox.dialog({
                        size: "large",
                        title: "<i class='fa fa-list'>  </i> |  Details " + popupTitle + "",
                        message: data,
                        closeButton: true,
                        buttons: {
                            success: {
                                label: "Close",
                                className: "jsLoading    btn btn-default",
                                callback: function () {
                                    bootbox.hideAll();
                                }
                            }
                        }
                    });
                    RemoveLoader();
                },
                complete: function (data) {
                    RemoveLoader();
                },
                error: function (data) {
                    RemoveLoader();
                }
            });
        }

        function FillData() {
            CancelAdd();
            AddLoader();
            $("#tblData").html(
                '<tr><td class="text-center">Working on it <img src="/Images/inlineloader.gif" /> </td> </tr>');

            $.ajax({
                type: 'POST',
                url: '@Url.Action("GetBooks", "Books", new {area="Master"})',
                data: {
                    MasterCategoryId: @Model.iId
                },
                dataType: "json",
                success: function (data) {

                    var rowdata = '';
                    var cssclas = "";

                    if (data.StatusCode == 200) {
                        var currentstatus = "";

                        var thead = "<thead><tr>  <th class='text-left' >Book Name </th>" +
                            " <th class='text-center' width='20%'  title='Action'><i class='fa fa-cogs'></i></th> </tr>   <tr></thead>  ";

                        $.each(data.results, function () {

                            if (this.Status == '@DC.Status.Active.GetHashCode()') {
                                currentstatus = '&nbsp;<button data-id="' + this.Id +
                                    '"  data-title="' + this.Title +
                                    '" title="Currennt status is Active click to In-Active." type="button" class="jsLoading jsActiveInactive btn btn-primary btn-xs"><i class="fa fa-check-square"></i></button>';
                                cssclas = "";

                            } else {
                                currentstatus = '&nbsp;<button data-id="' + this.Id +
                                    '"  data-title="' + this.Title +
                                    '" title="Currennt status is In-Active click to Active." type="button" class="jsLoading jsActiveInactive btn btn-primary btn-xs"><i class="fa fa-close"></i></button>'
                                cssclas = "td-inactive";

                            }
                            rowdata += '<tr id="tr_' + this.Id + '" class="' + cssclas + '" >' +
                                '<td class="text-left">' +
                                '<a data-title="' + this.Title + '" data-id="' + this.Id +
                                '" title="Click for view data." class="jsLoading jsView" href="javascript:void(0);"><img onerror="SetImageDefault(this)" class="zoom img-thumbnail rounded-circle " style="height:50px; width:50px;" src="/Attatchments/Book/th_' +
                                this.Image + '">&nbsp; <strong>' + this.Title + '</strong> | ' +

                                this.ISBN + ' | Autor ' + this.Author + ' | e Book Price ' + this
                                .EbookPrice + ' | Print Book Price ' + this.EbookPrice + '  </a>'+
                                '</td>' +
                                ' <td class="text-center">' +
                                ' <div class="box_icon">' +

                                '&nbsp;<button   type="button" data-title="Edit ' + this.Title +
                                '" data-id="' + this.Id +
                                '" title="Click for edit data" class="jsLoading jsEdit btn btn-primary btn-xs"><i class="fa fa-pencil"></i></button>' +
                                '' + currentstatus + '' +
                                '&nbsp;<button type="button" class="btn btn-primary btn-xs"  data-title="' + this.Title +
                                '" data-id="' + this.Id +
                                '" title="Click for delete" class="jsLoading jsDelete btn btn-primary btn-xs"><i class="fa fa-trash text-danger"></i></button>' +
                                '</td></div></tr>';

                        });

                        if (data.results.length > 0) {
                            $("#tblData").html(thead + rowdata);
                            RemoveLoader();
                            Search();
                        } else {

                            $("#tblData").html('<tr><td class="tetx-left h3 text-danger">' + data.Message +
                                ' .</td></tr>');
                            $.toaster({
                                priority: 'danger',
                                title: "Error",
                                message: data.Message
                            });
                            RemoveLoader();
                        }

                    } else if (data.StatusCode == 201) {
                        //$.toaster({ priority: 'info', title: "Info", message: data.Message });
                        $("#tblData").html('<tr><td class="tetx-left h3 text-info">' + data.Message +
                            ' .</td></tr>');
                        RemoveLoader();
                    } else {
                        $.toaster({
                            priority: 'danger',
                            title: "Error",
                            message: "Some error occur try later."
                        });
                        $("#tblData").html(
                            '<tr><td class="tetx-left h3 text-danger">Some error occur try later.</td></tr>'
                        );
                        RemoveLoader();
                    }
                },
                complete: function (data) {
                    RemoveLoader();
                },
                error: function (data) {
                    $.toaster({
                        priority: 'danger',
                        title: "Error",
                        message: "Some error occur try later."
                    });
                    $("#tblData").html(
                        '<tr><td class="tetx-left h3 text-danger">Some error occur try later.</td></tr>'
                    );
                    RemoveLoader();
                },
            });
        }

        function CheckDelete(popupTitle, id) {
            AddLoader();
            $.ajax({
                type: "POST",
                url: '@Url.Action("CheckForDeleteBook", "Books", new {area="Master" })',
                data: {
                    Id: id
                },
                success: function (data) {
                    bootbox.dialog({
                        size: "large",
                        title: "<i class='fa fa-trash'>  </i> | Delete Data : " + popupTitle + "",
                        message: data,
                        closeButton: true,
                        buttons: {
                            cancel: {
                                className: 'btn-sm btn-outline-primary',
                                label: '<i class="fa fa-times"></i> Cancel'
                            },
                            confirm: {
                                className: 'btn-sm btn-outline-danger jsConfirmDelete',
                                label: '<i class="fa fa-check"></i> Confirm',
                                callback: function () {
                                    $("#frmDelete").submit();
                                    return false;
                                }
                            }

                        }
                    });
                    RemoveLoader();
                },
                complete: function (data) {
                    RemoveLoader();
                },
                error: function (data) {
                    RemoveLoader();
                }
            });
        }

        function ActiveInactive(Id) {
            AddLoader();
            $.ajax({
                type: 'POST',
                url: '@Url.Action("ActiveInactiveBook", "Books", new {area="Master"})',
                data: {
                    Id: Id
                },
                dataType: "json",
                success: function (data) {
                    if (data.StatusCode == 200) {
                        FillData();
                        $.toaster({
                            priority: 'success',
                            title: "Active/Inactive",
                            message: data.Message
                        });
                        RemoveLoader();
                    } else {

                        $.toaster({
                            priority: 'danger',
                            title: '',
                            message: data.Message
                        });
                        RemoveLoader();
                    }
                },
                complete: function (data) {
                    RemoveLoader();
                },
                error: function (data) {
                    RemoveLoader();
                }

            });
        }
        $(function () {

            FillData();
            $(document).on("click", ".jsDelete", function (e) {
                var id = $(this).attr("data-id");
                var title = $(this).attr("data-title");

                CheckDelete(title, id);

            });
            $(document).ajaxSend(function (event, xhr, settings) {
                $(".jsLoading").attr("disabled", "disabled");;
            });
            $(document).ajaxComplete(function (event, xhr, settings) {
                $(".jsLoading").removeAttr("disabled");

            });


            $(document).on("submit", "#frmDelete", function (e) {
                AddLoader()
                e.preventDefault();
                $("#toaster").remove();
                var Id = $.trim($("#DeleteId").val());
                var Password = $.trim($("#Password").val());
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("DeleteBook", "Books", new {area="Master"})',
                    data: {
                        Id: Id,
                        Password: Password
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.StatusCode == 200) {
                            $.toaster({
                                priority: 'success',
                                title: "Success",
                                message: data.Message
                            });
                            $("#tr_" + Id + "").remove();
                            HidePopup();
                            RemoveLoader();
                        } else {
                            $.toaster({
                                priority: 'danger',
                                title: "Error",
                                message: data.Message
                            });
                            RemoveLoader();
                        }
                    },
                    complete: function (data) {
                        RemoveLoader();
                    },
                    error: function (data) {
                        RemoveLoader();
                    }
                });
            });
            $(document).on("submit", "#frmAddBook", function (e) {

                AddBookInDB(e)
            });
            $(document).on("click", ".jsView", function (e) {
                var dataid = $(this).attr("data-id");
                var datatitle = $(this).attr("data-title");
                View(datatitle, dataid);
            });
            $(document).on("click", ".jsEdit", function (e) {
                var id = $(this).attr("data-id");
                var title = $(this).attr("data-title");
                Add("Update Book.", id);
            });

            $(document).on("click", ".jsActiveInactive", function () {
                var id = $(this).attr("data-id");
                var title = $(this).attr("data-title");
                ActiveInactive(id);

            });

        });
    </script>
    }