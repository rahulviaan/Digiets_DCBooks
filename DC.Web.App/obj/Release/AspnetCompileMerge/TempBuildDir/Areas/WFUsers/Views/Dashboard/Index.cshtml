@model  DC.Web.App.Models.ViewModel<IEnumerable<DC.Web.App.Models.KeyValue>, string, string>
@{
    ViewBag.Title = "Manage " + Model.Title + "";
    var rolelist = (from item in Model.tData
                    select new SelectListItem
                    {
                        Text = item.Title,
                        Value = item.Id,
                    }).ToList();
}
<style>
    .table td {
        padding: 7px;
        vertical-align: top;
        border-top: 1px solid #dee2e6;
    }

    .table tr:hover {
        background: #f5efce;
    }

    element.style {
    }



    h1, .h1, h2, .h2, h3, .h3 {
        margin-top: 0px;
        margin-bottom: 5px;
    }

    .inputfile {
        width: 0.1px;
        height: 0.1px;
        opacity: 0;
        overflow: hidden;
        position: absolute;
        z-index: -1;
    }

        .inputfile + label {
            display: inline-block;
            padding: 3px 6px;
            border: 1px solid #9ACE48;
            background: #9ACE48;
            color: #fff;
            cursor: pointer;
        }
</style>
@if (Model.Status == 200)
{

<div class="container">

    <div class="row">
        <div class="col-lg-12">
<ol class="breadcrumb" id="olBredcrumb">
        <li class="breadcrumb-item hidden" id="btnBack">
            <a href="javascript:void(0);" onclick="CancelAdd();"><i class=" fa fa-arrow-circle-left"></i>&nbsp;Back </a>
        </li>
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index","Admin",new {area="CP" })">Home</a>
        </li>
        <li class="breadcrumb-item active "> <a href="@Url.Action("Users", "Manage", new { area = "" })">@Model.Title</a></li>
    </ol>
        </div>
    </div>
    

    @Html.Hidden("maxRows", "500")
    @Html.Hidden("page", "1")
    @Html.Hidden("currentRow", "0")

    <div class="row">
        <div class="col-lg-12">
       <div id="pageAdd" class="form-data"></div>
       </div>
    </div>

<div class="row">
    <div id="pageData" class="text-center">
        <div class="col-lg-2 col-xs-4">
            @Html.DropDownListFor(m => m.DatatId, rolelist, new { onchange = " FillData()", @class = "form-control" })
        </div>
        <div class="col-lg-7 col-xs-8">
            <div class="form-group has-feedback ">
                <input onkeyup="Search()" type="text" class="form-control" id="txtSearch" name="txtSearch" placeholder="Search By Name">
                <span class="fa fa-search form-control-feedback"></span>
            </div>
        </div>
        <div class="col-lg-2 col-xs-10 text-right ">

            <button type="button" title="Click refresh data." class="btn btn-sm  btn-primary" onclick="return FillData();"><i class="fa fa-refresh"></i></button>
            <button data-role="@Model.Title" data-roleid=" @Model.DatatId" type="button" id="btnAdd" onclick="return Add('Create New User','');" title="Click for add ." class="btn btn-sm btn-primary"><i class="fa fa-plus"></i></button>


        </div>
        <div class="col-lg-1 col-xs-2 text-left ">
            <div type="button" class="text-success" id="dvUploadButton_1">
                <input _dvuploadbutton="dvUploadButton_1" _index="1" type="file" onchange="UploadUserExcel(event,this)" name="Filename" id="flUpload1" class="jsFileUpload inputfile">
                <label class="img-rounded" title="Upload users." for="flUpload1"><i class="fa fa-file-excel-o" aria-hidden="true"></i></label>
            </div>
        </div>
        <div class="col-lg-12">
            <table id="tblData" class="table table-bordered">
                <tr>
                    <td class="text-center">
                        Working on it   <img src="~/Images/inlineloader.gif" />
                    </td>
                </tr>
            </table>
        </div>
    </div>
    </div>

   </div> 
    @section Scripts {


        <script src="~/Scripts/jquery.toaster.js"></script>
        <script src="~/Scripts/bootbox.min.js"></script>
        <script src="~/Scripts/Common.js"></script>

        <script>
            function CancelAdd() {
                $("#pageData").css({ "display": "" })
                $("#pageAdd").css({ "display": "none" })
                $("#btnBack").addClass("hidden");
            }
            function Search() {
                var input, filter, table, tr, td, i;
                input = document.getElementById("txtSearch");
                filter = input.value.toUpperCase();
                table = document.getElementById("tblData");
                tr = table.getElementsByTagName("tr");

                for (i = 0; i < tr.length; i++) {
                    td = tr[i].getElementsByTagName("td")[0];
                    if (td) {
                        if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
                            tr[i].style.display = "";
                        } else {
                            tr[i].style.display = "none";
                        }
                    }

                }
            }
            function Add(title,id) {
                var btnhtml = $("#btnAdd").html();
                $("#btnAdd").html("Wait.. <i class='fa fa-spinner fa-spin'></i>");
                $("#btnAdd").attr("disabled", "disabled");
                //var Role =  $("#btnAdd").attr("data-role");
                //var RoleId = $("#btnAdd").attr("data-roleid");

                var Role = $("#DatatId option:selected").text();
                var RoleId = $("#DatatId option:selected").val();

                 AddLoader();
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("Add", "Dashboard", new {area="WFUsers" })',
                    data: { Id: id, Title: title, Role: Role, RoleId: RoleId},
                    success: function (data) {
                        $("#btnAdd").html(btnhtml);
                        $("#btnAdd").removeAttr("disabled");
                        $("#pageAdd").css({ "display": "" });
                        $("#pageData").css({ "display": "none" });
                        $("#pageAdd").html(data);
                        title = title == "" ? "Create New " : title;
                        $("#h3Title").html(title);

                    },
                    complete: function (data) {
                        $("#btnAdd").html(btnhtml);
                        $("#btnAdd").removeAttr("disabled");
                        RemoveLoader();
                    },
                    error: function (data) {

                        $("#btnAdd").html(btnhtml);
                        $("#btnAdd").removeAttr("disabled");
                        RemoveLoader();
                    }
                });
            }
            function View(popupTitle, id, uc) {
                AddLoader();
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("ViewUser", "Dashboard", new {area= "WFUsers" })',
                    data: { Id: id, ucName: uc },
                    success: function (data) {

                        bootbox.dialog({
                            size: "large",
                            title: "<i class='fa fa-user'>  </i>      <small class='text-muted'> : " + popupTitle+"</small>",
                            message: data,
                            closeButton: true,
                            buttons: {
                                success: {
                                    label: "Close",
                                    className: "jsLoading    btn btn-default",
                                    callback: function () {
                                        bootbox.hideAll();
                                    }
                                }
                            }
                        });
                        RemoveLoader();
                    },
                    complete: function (data) {
                        RemoveLoader();
                    },
                    error: function (data) {
                        RemoveLoader();
                    }
                });
            }
            function FillData() {

                CancelAdd();
                AddLoader();

                $("#tblData").html('<tr><td class="text-center">Working on it <img src="/Images/inlineloader.gif" /> </td> </tr>');
                var RoleId = "";
                $.each($("#DatatId option"), function () {
                    RoleId += "'"+$(this).val() +"',"
                })
                RoleId = RoleId+"'1'"
                var maxRows = $.trim($("#maxRows").val());
                var page = $.trim($("#page").val());
                var currentRow = $.trim($("#currentRow").val());
                if (RoleId == "") {
                    $("#tblData").html('<tr><td class="tetx-left h3">Data not found.</td></tr>');
                    RemoveLoader();
                    return;
                }
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("Gets", "Dashboard", new {area="WFUsers"})',
                    data: {RoleId: RoleId, maxRows: maxRows, page: page, currentRow: currentRow},
                    dataType: "json",
                    success: function (data) {
                        var rowdata = '';
                        if (data.StatusCode == 200) {
                            var currentstatus = "";
                            var thead = "<thead><tr>  <th class='text-left' >User Detail</th>"
                                + " <th class='text-center' width='10%'  title='Action'><i class='fa fa-cogs'></i></th> </tr>   <tr></thead>  ";
                            var role = $("#DatatId option:selected").text();
                            var roleid = $("#DatatId option:selected").val();
                            var tdclass="td-inactive"
                            $.each(data.results, function () {
                                if (this.Status == '@DC.Status.Active.GetHashCode()') {
                                    tdclass = ""
                                    currentstatus = '&nbsp;<button data-id="' + this.Id + '"  data-title="' + this.UserName + '" title="Currennt status is Active click to In-Active." type="button" class="jsLoading jsActiveInactive btn btn-primary btn-xs"><i class="fa fa-check-square"></i></button>';
                                }
                                else {
                                    tdclass = "td-inactive"
                                    currentstatus = '&nbsp;<button data-id="' + this.Id + '"  data-title="' + this.UserName + '" title="Currennt status is In-Active click to Active." type="button" class="jsLoading jsActiveInactive btn btn-primary btn-xs"><i class="fa fa-close"></i></button>'
                                }
                                var detail = '<div class="text-muted small">Name: ' + this.FirstName + ' ' + this.LastName + ' | Mob No: ' + this.PhoneNumber + ' | Email: ' + this.Email + '  </div>'
                                rowdata += '<tr id="tr_' + this.Id + ' " class="' + tdclass +'">'
                                    + '<td class="text-left "> <a data-uc="' + this.ucName+'"  data-title="' + this.UserName + '" data-id="' + this.Id + '" title="Click for view data."  class="jsLoading jsView h4 text-primary" href="javascript:void(0);">  <h3>' + this.UserName +'</h3>'+ detail+  '   </a> </td>'
                                    + ' <td class="text-center"><button  data-role="' + role + '" data-roleid="' + roleid+'"  type="button" data-title="' + this.UserName + '" data-id="' + this.Id + '" title="Click for edit data."  class="jsLoading jsEdit btn btn-primary btn-xs"><i class="fa fa-pencil"></i></button>'
                                    + currentstatus
                                    + '</td></tr>';
                            });
                            if (data.results.length > 0) {
                                $("#tblData").html(thead + rowdata);
                                RemoveLoader();
                                Search();
                            }
                            else {

                                $("#tblData").html('<tr><td class="tetx-left h3 text-danger">' + data.Message+'</td></tr>');
                               // $.toaster({ priority: 'danger', title: "Error", message: data.Message });
                                RemoveLoader();
                            }

                        }

                        else if (data.StatusCode == 201) {
                            //$.toaster({ priority: 'info', title: "Info", message: data.Message });
                            $("#tblData").html('<tr><td class="tetx-left h3 text-info">' + data.Message + '</td></tr>');
                            RemoveLoader();
                        }
                        else {
                           // $.toaster({ priority: 'danger', title: "Error", message: "Some error occur try later." });
                            $("#tblData").html('<tr><td class="tetx-left h3 text-danger">Some error occur try later.</td></tr>');
                            RemoveLoader();
                        }
                    },
                    complete: function (data) {
                        RemoveLoader();
                    },
                    error: function (data) {
                       // $.toaster({ priority: 'danger', title: "Error", message: "Some error occur try later." });
                        $("#tblData").html('<tr><td class="tetx-left h3 text-danger">Some error occur try later.</td></tr>');
                        RemoveLoader();
                    },
                });
            }
            function ActiveInactive(Id) {
                $("#toaster").html("");
                AddLoader();
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("ActiveInactive", "Dashboard", new {area= "WFUsers" })',
                    data: { Id: Id},
                    dataType: "json",
                    success: function (data) {
                        if (data.StatusCode == 200) {
                            FillData();
                            $.toaster({ priority: 'success', title: "Active/Inactive", message: data.Message });
                            RemoveLoader();
                        }
                        else
                        {

                            $.toaster({ priority: 'danger', title: '', message: data.Message });
                            RemoveLoader();
                        }
                    },
                    complete: function (data) {
                        RemoveLoader();
                    },
                    error: function (data) {
                        console.log(data)
                        RemoveLoader();
                    }

                });
            }
            function HideUnHide(Id) {

                AddLoader();
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("Hide", "Area", new {area="Master"})',
                    data: { Id: Id},
                    dataType: "json",
                    success: function (data) {
                        if (data.StatusCode == 200) {
                            FillData();
                            $.toaster({ priority: 'success', title: "Hide/Un-Hide", message: data.Message });
                            RemoveLoader();
                        }
                        else
                        {

                            $.toaster({ priority: 'danger', title: '', message: data.Message });
                            RemoveLoader();
                        }
                    },
                    complete: function (data) {
                        RemoveLoader();
                    },
                    error: function (data) {
                        RemoveLoader();
                    },

                });
                }
            function UploadUserExcel(evt, objFile) {
                $("#toaster").html();
                var selectedFile = objFile.files[0]
                var filename = selectedFile.name;
                var fileExtension = ['xls', 'xlsx'];
                if ($.inArray(filename.split('.').pop().toLowerCase(), fileExtension) == -1) {
                    var err = "Invalid File. Please upload a File with" + " extension: " + fileExtension.join(", ") + "";
                    $.toaster({ priority: 'danger', title: "Required ", message: err });
                    return false;
                }
                var _dvUploadButton = $(objFile).attr("_dvUploadButton");
                if (selectedFile) {
                    var FileSize = 0;
                    var imageType = /application.*/;
                    if (selectedFile.size > 1048576) {
                        FileSize = Math.round(selectedFile.size * 100 / 1048576) / 100 + " MB";
                    }
                    else if (selectedFile.size > 1024) {
                        FileSize = Math.round(selectedFile.size * 100 / 1024) / 100 + " KB";
                    }
                    else {
                        FileSize = selectedFile.size + " Bytes";
                    }

                    if (selectedFile.type.match(imageType)) {
                        Upload(selectedFile, _dvUploadButton);
                    }
                    else {
                          $.toaster({ priority: 'danger', title: 'File type ', message: ' You are uploading invalid excel file type</strong> . Valid file type supported are .xls,xlsx .' });
                    }
                }
            }
        function Upload(selectedFile, _dvUploadButton) {
            AddLoader();
            $("#" + _dvUploadButton + " .jsFileUpload").attr("type", "hidden");
            $(".jsFileUpload").attr("type", "hidden");
            $("#" + _dvUploadButton + " label").html("<i class='fa  fa-spin fa-spinner'></i>");
            var hubid = $("#" + _dvUploadButton + " .jsFileUpload").attr("hub-id");
            var hubname = $("#" + _dvUploadButton + " .jsFileUpload").attr("hub-name");
            var dataString = new FormData();
            dataString.append("uploadedFile", selectedFile);
            //dataString.append("HubId", hubid);
            //dataString.append("HubName", hubname);

            $.ajax({
                url: '@Url.Action("UploadUserExcel", "Dashboard", new {area="WFUsers"})',  //Server script to process data
                type: 'POST',
                xhr: function () {  // Custom XMLHttpRequest
                    var myXhr = $.ajaxSettings.xhr();
                    return myXhr;
                },
                //Ajax events
                success: function (data) {
                    if (data.StatusCode == 200) {
                        $(".jsFileUpload").attr("type", "file");
                        $("#" + _dvUploadButton + " label").html('<i class="fa fa fa-file-excel-o"></i>');
                        //$.toaster({ priority: 'info', title: data.Title, message: data.Message });
                        bootbox.dialog({
                            size: "large",
                            title: "<span class='text-success'><i class='fa fa-file-excel-o'>  </i> " + data.Message + "</span>",
                            message: data.uc,
                            closeButton: true,
                            buttons: {
                                cancel: {
                                    className: 'btnbtn-outline-primary btn-lg',
                                    label: '<i class="fa fa-times"></i> Cancel',
                                    callback: function () {
                                        ClosePopup()
                                        
                                    }
                                },
                                confirm: {
                                    className: 'btn btn-primary btn-lg',
                                    label: '<i class="fa fa-check"></i> Submit',
                                    callback: function () {
                                        SubmitData();
                                        return false;
                                    }
                                }

                            }
                        });

                    }
                    else {

                        var message = data.Message == undefined ? "Error occur please try again." : data.Message
                        var title = data.Title == undefined ? "Error occur" : data.Title
                        $.toaster({ priority: 'danger', title: title, message: message});
                        $(".jsFileUpload").attr("type", "file");
                        $("#" + _dvUploadButton + " label").html('<i class="fa fa fa-file-excel-o"></i>');
                    }
                },
                error: function (data) {
                    $.toaster({ priority: 'danger', title: 'Error', message: 'Error occur please try again.' });
                    $(".jsFileUpload").attr("type", "file");
                    $("#" + _dvUploadButton + " label").html('<i class="fa fa fa-file-excel-o"></i>');
                    RemoveLoader();
                },
                complete: function (data) {
                    //$(".jsFileUpload").attr("type", "file");
                    //$("#" + _dvUploadButton + " label").html('<i class="fa fa fa-file-excel-o"></i> &nbsp; Upload Latest Inventory(.xls|.xlsx)');
                    RemoveLoader();
                },
                data: dataString,
                cache: false,
                contentType: false,
                processData: false
            });
         }

            $(function () {
             FillData();
            $(document).ajaxSend(function (event, xhr, settings) {
                $(".jsLoading").attr("disabled", "disabled");
            });
            $(document).ajaxComplete(function (event, xhr, settings) {
                $(".jsLoading").removeAttr("disabled");
            });


            $(document).on("submit", "#frmAddUser", function (e) {
                e.preventDefault();
                AddUser();
            });

            $(document).on("click", ".jsView", function (e) {
                var dataid = $(this).attr("data-id");
                var datatitle = $(this).attr("data-title");
                var uc = $(this).attr("data-uc");
                View(datatitle, dataid, uc);
            });
            $(document).on("click", ".jsEdit", function (e) {
                var id = $(this).attr("data-id");
                var title = $(this).attr("data-title");
                var role = $(this).attr("data-role");
                Add("Update | " + title+"",id);
            });
            $(document).on("click", ".jsActiveInactive", function () {
                var id = $(this).attr("data-id");
                var title = $(this).attr("data-title");
                ActiveInactive(id);

            });

            $(document).on("click", ".jsImg", function (e) {
                var src = $(this).attr("src")
                var title = $(this).attr("data-title")
                var html = '<div class="row"><div class="col-lg-12"><img class="img-responsive" style="width:100%"  src="' + src + '" alt=""></div><div class="col-lg-12"><h4>' + title + '</h4> </div></div>';
                //bootbox.dialog({
                //    title: title,
                //    message: ' <style> .modal-dialog {  max-width: 80% !important; margin: 1.75rem auto;} .modal-footer{text-align:center !important;}</style>' + html,
                //    closeButton: true,
                //    buttons: {
                //        success: {
                //            label: "Close",
                //            className: "jsLoading   btn btn-default",
                //            callback: function () {
                //                bootbox.hideAll();
                //            }
                //        }
                //    }
                //});

            });
        });
        </script>
    }
}
else
{
    <div class="col-md-12 text-center text-danger">
        <h4>@Model.Message</h4>
    </div>
}
